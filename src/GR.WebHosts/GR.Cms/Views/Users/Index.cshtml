@inject IStringLocalizer Localizer
@{
	ViewData["Title"] = Localizer["users"];
}

<UsersList />

@section Scripts {
	<script src="~/themes/gear/js/components/pageOptionsbar.js"></script>
	<script src="~/themes/gear/js/components/table/table.js"></script>
	<script src="~/themes/gear/js/components/modal.js"></script>
	<script src="~/themes/gear/js/components/form-controls/textarea.js"></script>
	<script src="~/themes/gear/js/components/form-controls/input.js"></script>
	<script src="~/themes/gear/js/components/form-controls/select.js"></script>
	<script src="~/themes/gear/js/components/phone-input/phone-input.js"></script>
	<script src="~/themes/gear/js/modalForms/modifyUserRolesModalForm.js"></script>
	<script>
		Vue.component('UsersList', {
			template: "#page-template",
			data() {
				return {
					apiUrl: apiEndpoints.Users.GetPaginatedUser,
					httpMethod: 'post',
					tableKey: 0,
					modalKey: 0,
					modalInviteKey: 0,
					refreshInputs: 0,
					refreshNewMemberInputs: 0,
					pageChange: 0,
					tableConfig: {
						currentPage: 0,
						pageSize: 20,
						rowCount: 0,
						sortCol: [
							{
								field: 'userFirstName',
								sortField: 'userFirstName',
								direction: 'asc'
							}
						]
					},
					tableFields: [
						{
							name: 'userFirstName',
							title: t('name'),
							sortField: 'userFirstName',
							visible: true
						},
						{
							name: 'email',
							title: t('email'),
							visible: true
						},
						{
							name: 'userRoles',
							title: t('roles'),
							visible: true
						},
						{
							name: 'isDisabled',
							title: t('status'),
							visible: true
						}
					],
					searchString: '',
					tableActions: {
						single: {
							"edit": { name: t('edit'), icon: "edit" },
							"manageRoles": { name: 'Manage Roles', icon: "shield" },
							"deactivate": { name: "Deactivate", icon: "eye-off" }
						},
						singleDisabled: {
							"activate": { name: "Activate", icon: "eye" },
							"delete": { name: t('delete'), icon: "delete" }
						},
						multiple: {
							"deactivate": { name: "Deactivate", icon: "eye-off" }
						},
						multipleDisabled: {
							"activate": { name: "Activate", icon: "eye" },
							"delete": { name: t('delete'), icon: "delete" }
						}
					},
					editableUserModal: false,
					waitAddButton: false,
					waitInviteAddButton: false,
					userValues: {},
					showFilters: false,
					inviteValues: {},
					pageRequestFilters: [],
					userRoles: [],
					jobPositions: [],
					users: []
				}
			},
			created() {
				this.resetUserValues();
				this.refreshInputs++;
				customAjaxRequest(apiEndpoints.Roles.GetAllRolesAsync).then(roles => {
					this.userRoles = this.convertToSelectList(roles);
					this.showFilters = true;
				});
				customAjaxRequest(apiEndpoints.JobPosition.GetAllJobPositions).then(result => {
					this.jobPositions = this.convertToSelectList(result);
				});
			},
			computed: {
				customQueryparams() {
					const params = {
						gSearch: this.searchString,
						includeDeleted: true
					};
					this.pageRequestFilters.forEach((a,i) => {
						for (pv in a) {
							params[`pageRequestFilters[${i}][${pv}]`] = a[pv];
						}
					});
					return params;
				},
				pageOptionsComponents() {
					return [
						{
							name: 'Button',
							props: {
								label: "@Localizer["add_user"]",
								className: 'ml-auto',
								btnType: 'success',
								onClick: () => {
									this.editableUserModal = false;
									this.resetUserValues();
									this.modalKey++;
									this.refreshInputs++;
									$(`#${this.modalUserProps.id}`).modal("show");
								}
							}
						},
						{
							name: 'Button',
							props: {
								label: "@Localizer["system_invite_user"]",
								className: 'ml-2',
								btnType: 'success',
								onClick: () => {
									this.resetInviteValues();
									this.modalInviteKey++;
									$(`#${this.modalInviteProps.id}`).modal("show");
								}
							}
						}
					]
				},
				userFormSubmits() {
					const resultArray = [
						{
							name: 'Button',
							props: {
								label: "@Localizer["cancel"]",
								btnType: 'outline-secondary',
								onClick: () => {
									$(`#${this.modalUserProps.id}`).modal("hide");
								}
							}
						}
					];
					if (!this.editableUserModal) {
						resultArray.push(
							{
								name: 'Button',
								props: {
									label: "@Localizer["add"]",
									btnType: 'success',
									waiting: this.waitAddButton,
									btnDOMType: 'submit'
								}
							}
						);
					} else {
						resultArray.push(
							{
								name: 'Button',
								props: {
									label:"@Localizer["save"]",
									btnType: 'success',
									waiting: this.waitAddButton,
									btnDOMType: 'submit'
								}
							}
						);
					}
					return resultArray;
				},
				modalUserlabel() {
					return this.editableUserModal ? t('edit_user') : t('add_user');
				},
				modalUserProps() {
					return {
						id: 'userModal',
						label: this.modalUserlabel,
						formInputs: [
							{
								name: 'Input',
								props: {
									id: 'user-firstName',
									type: 'text',
									label: t('system_first_name'),
									required: true,
									value: this.userValues.firstName,
									className: 'col-12 col-md-6',
									validator: value => fieldValidationFunc(value, 'varChar50'),
									validatorInput: value => fieldValidationInputFunc(value, 'varChar50')
								}
							},
							{
								name: 'Input',
								props: {
									id: 'user-lastName',
									type: 'text',
									label: t('system_last_name'),
									required: true,
									value: this.userValues.lastName,
									className: 'col-12 col-md-6',
									validator: value => fieldValidationFunc(value, 'varChar50'),
									validatorInput: value => fieldValidationInputFunc(value, 'varChar50')
								}
							},
							{
								name: 'Input',
								props: {
									id: 'user-email',
									type: 'text',
									label: t('email'),
									required: true,
									value: this.userValues.email,
									className: 'col-12 col-md-6',
									validator: value => fieldValidationFunc(value, 'email'),
									validatorInput: value => fieldValidationInputFunc(value, 'email')
								}
							},
							@*{
								name: 'Input',
								props: {
									id: 'user-phoneNumber',
									type: 'text',
									label: t('system_phone'),
									required: true,
									value: this.userValues.phoneNumber,
									className: 'col-12 col-md-6',
									validator: value => fieldValidationFunc(value, 'phone'),
									validatorInput: value => fieldValidationInputFunc(value, 'phone')
								}
							},*@
							{
								name: 'PhoneInput',
								props: {
									id: 'user-number',
									type: 'text',
									label: t('system_phone'),
									className: 'col-12 col-md-6',
									dialCode: this.userValues.dialCode,
									defaultCountry: 'MD',
									value: this.userValues.phoneNumber,
								}
							},
							{
								name: 'Input',
								props: {
									id: 'user-password',
									type: 'password',
									label: t('system_auth_password'),
									required: !this.editableUserModal,
									value: this.userValues.password,
									className: 'col-12 col-md-6',
									validator: value => fieldValidationFunc(value, 'password')
								}
							},
							{
								name: 'Input',
								props: {
									id: 'user-repeatPassword',
									type: 'password',
									label: 'Confirm password',
									required: !this.editableUserModal,
									value: this.userValues.repeatPassword,
									className: 'col-12 col-md-6',
									validator: value => { return value === this.userValues.password ? true : window.translate('system_field_invalid_repeat_password') }
								}
							},
							{
								name: 'Select',
								props: {
									id: 'user-isDeleted',
									label: t('status'),
									options: [
										{
											label: 'Active',
											value: 'false',
										},
										{
											label: 'Inactive',
											value: 'true'
										}
									],
									required: true,
									value: this.userValues.isDeleted,
									className: 'col-12 col-md-6'
								}
							},
							{
								name: 'Select',
								props: {
									id: 'user-selectedRoleId',
									label: t('roles'),
									options: this.userRoles,
									multiple: true,
									required: true,
									value: this.userValues.selectedRoleId,
									className: 'col-12 col-md-6'
								}
							},
							{
								name: 'Select',
								props: {
									id: 'user-jobPositionId',
									label: t('details_job_position'),
									options: this.jobPositions,
									required: false,
									value: this.userValues.jobPositionId,
									className: 'col-12'
								}
							},
						],
						formSubmits: this.userFormSubmits,
						onSubmit: () => {
							if (this.editableUserModal) {
								this.updateUser().then(() => {
									$(`#${this.modalUserProps.id}`).modal("hide");
								});
							} else {
								this.addNewUser().then(() => {
									$(`#${this.modalUserProps.id}`).modal("hide");
								});
							}
						}
					}
				},
				modalInviteProps() {
					return {
						id: 'inviteModal',
						label: t('system_invite_user'),
						formInputs: [
							{
								name: 'Input',
								props: {
									id: 'invite-firstName',
									type: 'text',
									label: t('system_first_name'),
									required: true,
									value: this.userValues.firstName,
									className: 'col-12 col-md-6',
									validator: value => fieldValidationFunc(value, 'varChar50'),
									validatorInput: value => fieldValidationInputFunc(value, 'varChar50')
								}
							},
							{
								name: 'Input',
								props: {
									id: 'invite-lastName',
									type: 'text',
									label: t('system_last_name'),
									required: true,
									value: this.userValues.lastName,
									className: 'col-12 col-md-6',
									validator: value => fieldValidationFunc(value, 'varChar50'),
									validatorInput: value => fieldValidationInputFunc(value, 'varChar50')
								}
							},
							{
								name: 'Input',
								props: {
									id: 'invite-email',
									type: 'text',
									label: t('email'),
									required: true,
									value: this.userValues.email,
									className: 'col-12',
									validator: value => fieldValidationFunc(value, 'email'),
									validatorInput: value => fieldValidationInputFunc(value, 'email')
								}
							},
							{
								name: 'Select',
								props: {
									id: 'invite-roles',
									label: t('roles'),
									options: this.userRoles,
									multiple: true,
									required: true,
									value: this.inviteValues.roles,
									className: 'col-12'
								}
							}
						],
						formSubmits: [
							{
								name: 'Button',
								props: {
									label: "@Localizer["cancel"]",
									btnType: 'outline-secondary',
									onClick: () => {
										$(`#${this.modalInviteProps.id}`).modal("hide");
									}
								}
							},
							{
								name: 'Button',
								props: {
									label: "@Localizer["system_invite_user"]",
									btnType: 'success',
									waiting: this.waitInviteAddButton,
									btnDOMType: 'submit'
								}
							}
						],
						onSubmit: () => {
							this.inviteUser().finally(() => {
								$(`#${this.modalInviteProps.id}`).modal("hide");
							});
						}
					}
				},
				rolesListFilter() {
					let newArray = [];
					this.userRoles.forEach(e => {
						let newElem = Object.assign({}, e);
						newElem.active = false;
						newArray.push(newElem);
					});
					return newArray;
				},
				tableFilters() {
					return [
						{
							id: 'Role',
							label: t('role'),
							values: this.rolesListFilter
						},
						{
							id: 'IsDeleted',
							label: t('status'),
							values: [
								{
									label: 'Active',
									value: false,
									active: false
								},
								{
									label: 'Inactive',
									value: true,
									active: false
								}
							]
						}
					]
				},
			},
			methods: {
				async addNewUser() {
					this.waitAddButton = true;
					this.userValues.userName = this.userValues.email.split("@@")[0]
					this.userValues.dialCode = `+${this.userValues.dialCode}`;
					return new Promise((resolve, reject) => {
						customAjaxRequest(apiEndpoints.Users.AddUser, 'PUT', this.userValues).then(() => {
							this.tableKey++;
							resolve(true);
						}).catch(e => {
							toast.notifyErrorList(e);
							reject(false);
						}).finally(() => {
							this.waitAddButton = false;
						});
					});
				},
				async deleteUsers(users) {
					users.forEach((id, i, a) => {
						customAjaxRequest(apiEndpoints.Users.DeleteUser, 'DELETE', { id }).then(() => {
							if (i === a.length - 1) {
								this.tableKey++;
							}
						}).catch(e => {
							toast.notifyErrorList(e);
						});
					});
				},
				async deactivateUsers(users) {
					users.forEach((userId, i, a) => {
						customAjaxRequest(apiEndpoints.Users.DeactivateUser, 'POST', { userId }).then(() => {
							if (i === a.length - 1) {
								this.tableKey++;
							}
						}).catch(e => {
							toast.notifyErrorList(e);
						});
					});
				},
				async activateUsers(users) {
					users.forEach((userId, i, a) => {
						customAjaxRequest(apiEndpoints.Users.ActivateUser, 'GET', { userId }).then(() => {
							if (i === a.length - 1) {
								this.tableKey++;
							}
						}).catch(e => {
							toast.notifyErrorList(e);
						});
					});
				},
				async inviteUser() {
					this.waitInviteAddButton = true;
					return new Promise((resolve, reject) => {
						customAjaxRequest(apiEndpoints.Users.InviteNewUserAsync, 'POST', this.inviteValues).then(() => {
							this.tableKey++;
							toast.notify
							resolve(true);
						}).catch(e => {
							toast.notify({ heading: 'Email sent', icon: "success" });
							reject(false);
						}).finally(() => {
							this.waitInviteAddButton = false;
						});
					});
				},
				async updateUser() {
					this.userValues.dialCode = `+${this.userValues.dialCode}`;
					this.waitAddButton = true;
					if (!this.userValues.password) {
						delete this.userValues.password;
						delete this.userValues.repeatPassword;
					}
					return new Promise((resolve, reject) => {
						customAjaxRequest(apiEndpoints.Users.UpdateUser, 'POST', this.userValues).then(() => {
							this.tableKey++;
							resolve(true);
						}).catch(e => {
							toast.notifyErrorList(e);
							reject(false);
						}).finally(() => {
							this.waitAddButton = false;
						});
					});
				},
				async loadUser(userId) {
					return new Promise((resolve, reject) => {
						customAjaxRequest(apiEndpoints.Users.GetUserById, 'GET', {userId}).then(result => {
							this.tableKey++;
							resolve(result);
						}).catch(e => {
							toast.notifyErrorList(e);
							reject(false);
						});
					});
				},
				editUser(userId) {
					this.resetUserValues();
					this.loadUser(userId).then(user => {
						this.userValues.id = user.id;
						this.userValues.firstName = user.userFirstName;
						this.userValues.lastName = user.userLastName;
						this.userValues.email = user.email;
						this.userValues.phoneNumber = user.phoneNumber || ''
						this.userValues.dialCode = user.dialCode;
						this.userValues.isDeleted = user.isDeleted;
						this.userValues.selectedRoleId = user.userRolesId;
						this.userValues.jobPositionId = user.jobPositionId;
						this.userValues.userName = user.userName;
						this.editableUserModal = true;
						this.modalKey++;
						this.refreshInputs++;
						$(`#${this.modalUserProps.id}`).modal("show");
					})
				},
				manageRoles(userId) {
					this.$refs['modifyRolesModal'].openModal(userId);
				},
				emitValueUser(val) {
					if (val.id === 'user-number') {
						this.userValues.phoneNumber = val.value.number;
						this.userValues.dialCode = val.value.dialCode;
						return;
					}
					const newVal = val.value === 'true' ? true : val.value === 'false' ? false : val.value;
					this.userValues[val.id.replace('user-', '')] = newVal;
				},
				emitInviteUser(val) {
					const newVal = val.value === 'true' ? true : val.value === 'false' ? false : val.value;
					this.inviteValues[val.id.replace('invite-', '')] = newVal;
				},
				resetUserValues() {
					this.userValues =  {
						firstName: null,
						lastName: null,
						email: null,
						phoneNumber: '',
						password: null,
						repeatPassword: null,
						isDeleted: false,
						selectedRoleId: [],
						jobPositionId: null,
						authenticationType: 'local',
						userName: null,
						dialCode: ''
					}
				},
				resetInviteValues() {
					this.inviteValues = {
						email: null,
						roles: [],
						firstName: null,
						lastName: null
					}
				},
				findObjectByPropValue(array, value, prop) {
					return array.find(x => x[prop] === value);
				},
				changeObjPropInArrayById(array, value, prop, id, idProp) {
					for (var i in array) {
						if (array[i][idProp] == id) {
							array[i][prop] = value;
							break;
						}
					}
				},
				action(action) {
					if (action.key == 'deactivate') {
						this.deactivateUsers(action.value);
					} else if (action.key == 'activate') {
						this.activateUsers(action.value);
					} else if (action.key == 'edit') {
						this.editUser(action.value[0]);
					} else if (action.key == 'delete') {
						this.deleteUsers(action.value);
					} else if (action.key == 'manageRoles') {
						this.manageRoles(action.value[0])
					}
				},
				convertToSelectList(array) {
					return array.map(e => {
						const newObj = {
							label: e.name,
							value: e.id
						}
						return newObj;
					});
				},
				searchTable(val) {
					if (val.length > 2) {
						this.searchString = val;
						this.tableKey++;
					} else if (val === '') {
						this.searchString = '';
						this.tableKey++;
					}
				},
				tableDataLoaded(data) {
					this.users = data;
				},
				filterResult(val) {
					this.pageRequestFilters = [];
					val.forEach(f => {
						f.values.forEach(v => {
							if (v.active) {
								this.pageRequestFilters.push({
									Propriety: f.id,
									Value: v.value
								});
							}
						});
					});
					this.tableKey++;
				}
			},
			mounted() {
				window.addEventListener('popstate', (event) => {
					this.pageChange++;
				});
			},
		});
	</script>
	<script type="text/x-template" id="page-template">
		<div>
			<PageOptionsBar v-if="showFilters"
							:searcheable="true"
							:pageOptionsComponents="pageOptionsComponents"
							@@searchInput="searchTable"
							:filters="tableFilters"
							@@filterResult="filterResult" />
			<Table :fields="tableFields"
				   :apiUrl="apiUrl"
				   :httpMethod="httpMethod"
				   @@triggeredMenuAction="action"
				   @@onLoad="tableDataLoaded"
				   tableId="users-table"
				   :sortOrder="tableConfig.sortCol"
				   :initialPageSize="20"
				   :reload="tableKey"
				   dataPath="result.result"
				   :customQueryparams="customQueryparams"
				   :hasCustomQUeryparams="true"
				   :controller="'Users'"
				   :changeUrl="true"
				   :pageChange="pageChange"
				   :actionsSingle="tableActions.single"
				   :actionsSingleDisabled="tableActions.singleDisabled"
				   :actionsMultiple="tableActions.multiple"
				   :actionsMultipleDisabled="tableActions.multipleDisabled"
				   :haveContextMenu="true">
				<slot slot="userFirstName" slot-scope="props">
					{{ props.rowData.userFirstName ? props.rowData.userFirstName : '' }}
					{{ props.rowData.userLastName ? props.rowData.userLastName : '' }}
				</slot>
				<slot slot="userRoles" slot-scope="props">
					<template v-for="role in props.rowData.userRoles">
						<p v-if="role" class="m-0 last-child-mb-2" :key="role.id">
							{{ role.name }}
						</p>
					</template>
				</slot>
				<slot slot="isDisabled" slot-scope="props">
					<span v-if="props.rowData.isDisabled" class="badge badge-outline-secondary">Inactive</span>
					<span v-else class="badge badge-outline-success">Active</span>
				</slot>
			</Table>
			<Modal :modalProps="modalUserProps" @@newValue="emitValueUser" :refreshInputs="refreshInputs" :inputsKey="modalKey" />
			<Modal :modalProps="modalInviteProps" @@newValue="emitInviteUser" :refreshInputs="refreshInputs" :inputsKey="modalInviteKey" />
			<ModifyUserRolesModalForm ref="modifyRolesModal" @@updateTableKey="tableKey++" />
		</div>
	</script>
}
